class CampaignLevel{constructor(id,name,desc,seed,objectives,rewards){this.id=id;this.name=name;this.description=desc;this.seed=seed;this.objectives=objectives;this.rewards=rewards;this.completed=false;this.bestScore=0}checkObjectives(game){const r={};this.objectives.forEach(o=>r[o.id]=o.check(game));return r}isComplete(game){return this.objectives.every(o=>o.check(game))}}class CampaignObjective{constructor(id,desc,check){this.id=id;this.description=desc;this.check=check}}class CampaignSystem{constructor(){this.levels=this.init();this.currentLevel=null;this.campaignMode=false;this.load()}init(){return[new CampaignLevel("level1","Tutorial","Learn basics",12345,[new CampaignObjective("survive_3","Survive 3 waves",g=>g.wave>=3),new CampaignObjective("place_5","Place 5 towers",g=>g.totalTowersPlaced>=5)],{currency:200,research:5}),new CampaignLevel("level2","First Challenge","Defend waves",54321,[new CampaignObjective("survive_5","Survive 5 waves",g=>g.wave>=5),new CampaignObjective("perfect","One perfect wave",g=>g.stats.perfectWaves>=1)],{currency:300,research:10}),new CampaignLevel("level3","Advanced","Master upgrades",98765,[new CampaignObjective("survive_10","Survive 10 waves",g=>g.wave>=10),new CampaignObjective("upgrade","Upgrade to level 3",g=>g.towers.some(t=>t.level>=3))],{currency:500,research:15})]}startLevel(id,game){const l=this.levels.find(x=>x.id===id);if(!l)return false;this.currentLevel=l;this.campaignMode=true;game.mapSeed=l.seed;game.regenerateMap(l.seed);game.wave=0;game.currency=game.getStartingCurrency();game.health=100;return true}checkLevelCompletion(game){if(!this.currentLevel||!this.currentLevel.isComplete(game))return false;this.currentLevel.completed=true;if(this.currentLevel.rewards.currency)game.currency+=this.currentLevel.rewards.currency;if(this.currentLevel.rewards.research)game.researchSystem.addResearchPoints(this.currentLevel.rewards.research);this.save();return true}save(){try{const d={levels:{}};this.levels.forEach(l=>d.levels[l.id]={completed:l.completed,bestScore:l.bestScore});localStorage.setItem("towerDefenseCampaign",JSON.stringify(d))}catch(e){console.error("Error saving campaign:",e)}}load(){try{const s=localStorage.getItem("towerDefenseCampaign");if(s){const d=JSON.parse(s);if(d.levels)this.levels.forEach(l=>{if(d.levels[l.id]){l.completed=d.levels[l.id].completed;l.bestScore=d.levels[l.id].bestScore||0}})}}catch(e){console.error("Error loading campaign:",e)}}getNextUnlocked(){if(this.levels.length===0)return null;if(!this.levels[0].completed)return this.levels[0];for(let i=1;i<this.levels.length;i++){if(this.levels[i-1].completed&&!this.levels[i].completed)return this.levels[i]}return null}}
